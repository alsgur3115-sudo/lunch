import { useState } from 'react';
import { Cloud, Sun, CloudRain, Snowflake, Wind, Utensils, Coffee } from 'lucide-react';

export default function LunchRecommender() {
  const [weather, setWeather] = useState('');
  const [temperature, setTemperature] = useState('');
  const [recommendation, setRecommendation] = useState(null);
  const [loading, setLoading] = useState(false);

  const weatherOptions = [
    { value: 'ë§‘ìŒ', label: 'â˜€ï¸ ë§‘ìŒ', icon: Sun },
    { value: 'íë¦¼', label: 'â˜ï¸ íë¦¼', icon: Cloud },
    { value: 'ë¹„', label: 'ğŸŒ§ï¸ ë¹„', icon: CloudRain },
    { value: 'ëˆˆ', label: 'â„ï¸ ëˆˆ', icon: Snowflake },
    { value: 'ë°”ëŒ', label: 'ğŸ’¨ ë°”ëŒ', icon: Wind }
  ];

  const getRecommendation = async () => {
    if (!weather) {
      alert('ë‚ ì”¨ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
      return;
    }

    setLoading(true);
    setRecommendation(null);

    try {
      const today = new Date().toLocaleDateString('ko-KR', {
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });

      const tempInfo = temperature ? `ê¸°ì˜¨ì€ ${temperature}ë„` : 'ê¸°ì˜¨ ì •ë³´ ì—†ìŒ';
      
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1000,
          messages: [{
            role: 'user',
            content: `ì˜¤ëŠ˜ì€ ${today}ì´ê³ , ë‚ ì”¨ëŠ” ${weather}ì…ë‹ˆë‹¤. ${tempInfo}ì…ë‹ˆë‹¤.

ì´ ë‚ ì”¨ì— ë”± ë§ëŠ” ì ì‹¬ ë©”ë‰´ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”. ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”:

{
  "mainMenu": "ì¶”ì²œ ë©”ì¸ ë©”ë‰´ ì´ë¦„",
  "description": "ì´ ë©”ë‰´ë¥¼ ì¶”ì²œí•˜ëŠ” ì´ìœ  (2-3ë¬¸ì¥, ë‚ ì”¨ì™€ ì—°ê´€ì§€ì–´)",
  "alternatives": ["ëŒ€ì²´ ë©”ë‰´1", "ëŒ€ì²´ ë©”ë‰´2", "ëŒ€ì²´ ë©”ë‰´3"],
  "sideDish": "ì–´ìš¸ë¦¬ëŠ” ì‚¬ì´ë“œ ë©”ë‰´",
  "drink": "ì¶”ì²œ ìŒë£Œ",
  "tip": "ë§›ìˆê²Œ ë¨¹ëŠ” íŒ (1ë¬¸ì¥)"
}

êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ì¸ í•œì‹, ì¤‘ì‹, ì¼ì‹, ì–‘ì‹ ë“± ë‹¤ì–‘í•œ ë©”ë‰´ë¥¼ ì¶”ì²œí•´ì£¼ì„¸ìš”.`
          }]
        })
      });

      const data = await response.json();
      
      if (!data.content || !data.content[0]) {
        throw new Error('Invalid API response');
      }
      
      const content = data.content[0].text;
      
      // JSON íŒŒì‹±
      let cleanContent = content.replace(/```json\n?|\n?```/g, '').trim();
      
      const firstBrace = cleanContent.indexOf('{');
      const lastBrace = cleanContent.lastIndexOf('}');
      if (firstBrace !== -1 && lastBrace !== -1) {
        cleanContent = cleanContent.substring(firstBrace, lastBrace + 1);
      }
      
      const menuData = JSON.parse(cleanContent);
      
      if (!menuData.mainMenu || !menuData.description) {
        throw new Error('Invalid menu data');
      }
      
      setRecommendation(menuData);
    } catch (error) {
      console.error('Error:', error);
      alert('ë©”ë‰´ ì¶”ì²œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-orange-400 via-pink-400 to-purple-500 p-4 flex items-center justify-center">
      <div className="max-w-3xl w-full">
        {/* í—¤ë” */}
        <div className="text-center mb-8">
          <div className="flex items-center justify-center gap-3 mb-4">
            <Utensils className="w-10 h-10 text-white animate-bounce" />
            <h1 className="text-5xl font-bold text-white">ì ì‹¬ ë­ ë¨¹ì§€?</h1>
            <Coffee className="w-10 h-10 text-white animate-bounce" />
          </div>
          <p className="text-white/90 text-lg">ì˜¤ëŠ˜ ë‚ ì”¨ì— ë”± ë§ëŠ” ë©”ë‰´ë¥¼ ì¶”ì²œí•´ë“œë ¤ìš”</p>
        </div>

        {/* ì…ë ¥ ì¹´ë“œ */}
        <div className="bg-white rounded-3xl p-8 shadow-2xl mb-6">
          <div className="space-y-6">
            {/* ë‚ ì”¨ ì„ íƒ */}
            <div>
              <label className="block text-gray-700 font-semibold mb-3 text-lg">
                ğŸŒ¤ï¸ ì˜¤ëŠ˜ ë‚ ì”¨ëŠ”?
              </label>
              <div className="grid grid-cols-2 sm:grid-cols-5 gap-3">
                {weatherOptions.map((option) => (
                  <button
                    key={option.value}
                    onClick={() => setWeather(option.value)}
                    className={`p-4 rounded-xl border-2 transition-all duration-200 font-medium ${
                      weather === option.value
                        ? 'border-orange-500 bg-orange-50 text-orange-700 scale-105'
                        : 'border-gray-200 bg-white hover:border-orange-300 hover:bg-orange-50'
                    }`}
                  >
                    <div className="text-2xl mb-1">{option.label.split(' ')[0]}</div>
                    <div className="text-sm">{option.label.split(' ')[1]}</div>
                  </button>
                ))}
              </div>
            </div>

            {/* ê¸°ì˜¨ ì…ë ¥ (ì„ íƒì‚¬í•­) */}
            <div>
              <label className="block text-gray-700 font-semibold mb-3 text-lg">
                ğŸŒ¡ï¸ ê¸°ì˜¨ (ì„ íƒì‚¬í•­)
              </label>
              <div className="flex items-center gap-3">
                <input
                  type="number"
                  value={temperature}
                  onChange={(e) => setTemperature(e.target.value)}
                  placeholder="ì˜ˆ: 25"
                  className="flex-1 px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-orange-400 focus:outline-none text-lg"
                />
                <span className="text-2xl text-gray-600">Â°C</span>
              </div>
            </div>

            {/* ì¶”ì²œ ë²„íŠ¼ */}
            <button
              onClick={getRecommendation}
              disabled={loading}
              className="w-full py-4 bg-gradient-to-r from-orange-500 to-pink-500 text-white font-bold text-xl rounded-xl hover:from-orange-600 hover:to-pink-600 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed shadow-lg hover:shadow-xl transform hover:scale-105"
            >
              {loading ? 'ë©”ë‰´ ê³ ë¥´ëŠ” ì¤‘... ğŸ³' : 'ë©”ë‰´ ì¶”ì²œë°›ê¸° ğŸ½ï¸'}
            </button>
          </div>
        </div>

        {/* ì¶”ì²œ ê²°ê³¼ */}
        {recommendation && (
          <div className="bg-white rounded-3xl p-8 shadow-2xl animate-fadeIn">
            <div className="space-y-6">
              {/* ë©”ì¸ ë©”ë‰´ */}
              <div className="text-center pb-6 border-b-2 border-gray-100">
                <div className="text-6xl mb-4">ğŸ½ï¸</div>
                <h2 className="text-4xl font-bold text-gray-800 mb-4">
                  {recommendation.mainMenu}
                </h2>
                <p className="text-gray-600 text-lg leading-relaxed">
                  {recommendation.description}
                </p>
              </div>

              {/* ëŒ€ì²´ ë©”ë‰´ */}
              {recommendation.alternatives && recommendation.alternatives.length > 0 && (
                <div className="bg-orange-50 rounded-2xl p-6">
                  <h3 className="text-xl font-bold text-gray-800 mb-3">
                    ğŸ”„ ë‹¤ë¥¸ ì„ íƒì§€
                  </h3>
                  <div className="flex flex-wrap gap-2">
                    {recommendation.alternatives.map((alt, index) => (
                      <span
                        key={index}
                        className="px-4 py-2 bg-white rounded-full text-gray-700 font-medium shadow-sm"
                      >
                        {alt}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* ì‚¬ì´ë“œ & ìŒë£Œ */}
              <div className="grid sm:grid-cols-2 gap-4">
                {recommendation.sideDish && (
                  <div className="bg-pink-50 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                      <span>ğŸ¥—</span> ì‚¬ì´ë“œ ë©”ë‰´
                    </h3>
                    <p className="text-gray-700">{recommendation.sideDish}</p>
                  </div>
                )}
                
                {recommendation.drink && (
                  <div className="bg-purple-50 rounded-2xl p-6">
                    <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                      <span>ğŸ¥¤</span> ì¶”ì²œ ìŒë£Œ
                    </h3>
                    <p className="text-gray-700">{recommendation.drink}</p>
                  </div>
                )}
              </div>

              {/* íŒ */}
              {recommendation.tip && (
                <div className="bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-6 border-2 border-yellow-200">
                  <h3 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <span>ğŸ’¡</span> ë§›ìˆê²Œ ë¨¹ëŠ” íŒ
                  </h3>
                  <p className="text-gray-700 italic">"{recommendation.tip}"</p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* í‘¸í„° */}
        <div className="text-center mt-8 text-white text-sm">
          <p>ğŸ´ ì˜¤ëŠ˜ë„ ë§›ìˆëŠ” ì ì‹¬ ë˜ì„¸ìš”! ğŸ´</p>
        </div>
      </div>

      <style jsx>{`
        @keyframes fadeIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        .animate-fadeIn {
          animation: fadeIn 0.5s ease-out;
        }
      `}</style>
    </div>
  );
}
